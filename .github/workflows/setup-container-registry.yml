name: Setup ECR Repository

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (development/qa/production)"
        required: true
        type: choice
        options:
          - development
          - production

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  APP_NAME: tow-management-system-api

jobs:
  create-ecr-repository:
    runs-on: ubuntu-latest

    # If manual run, use the chosen env; otherwise default to development (e.g., merges to main).
    environment: ${{ github.event_name == 'workflow_dispatch' && inputs.environment || 'development' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.GHA_RUNNER_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: account-id
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "AWS Account ID: $ACCOUNT_ID"

      - name: Create ECR Repository
        run: |
          set -euo pipefail
          
          REPO_NAME="${APP_NAME}"
          
          # Check if repository already exists
          if aws ecr describe-repositories \
            --repository-names "$REPO_NAME" \
            --region "${AWS_REGION}" >/dev/null 2>&1; then
            echo "ECR repository '$REPO_NAME' already exists"
            echo "Updating repository configuration..."
          
            # Update image tag mutability settings
            aws ecr put-image-tag-mutability \
              --repository-name "$REPO_NAME" \
              --image-tag-mutability MUTABLE_WITH_EXCLUSION \
              --image-tag-mutability-exclusion-filters filterType=WILDCARD,filter="v*" \
              --region "${AWS_REGION}"
          
            # Ensure repository is private (already created repositories are private by default)
            echo "Repository is private by default"
          else
            echo "Creating ECR repository: $REPO_NAME"
          
            # Create private repository with mutability settings
            aws ecr create-repository \
              --repository-name "$REPO_NAME" \
              --image-tag-mutability MUTABLE_WITH_EXCLUSION \
              --image-tag-mutability-exclusion-filters filterType=WILDCARD,filter="v*" \
              --region "${AWS_REGION}" >/dev/null
          
            echo "ECR repository '$REPO_NAME' created successfully"
          fi

      - name: Set Repository Policy for Lambda Image Retrieval
        run: |
          set -euo pipefail
          
          REPO_NAME="${APP_NAME}"
          ACCOUNT_ID="${{ steps.account-id.outputs.account_id }}"
          REPO_ARN="arn:aws:ecr:${AWS_REGION}:${ACCOUNT_ID}:repository/${REPO_NAME}"
          
          # LambdaECRImageRetrievalPolicy - Repository policy to allow Lambda to retrieve images
          REPOSITORY_POLICY='{
            "Version": "2012-10-17",
            "Statement": [
              {
                "Sid": "LambdaECRImageRetrievalPolicy",
                "Effect": "Allow",
                "Principal": {
                  "Service": "lambda.amazonaws.com"
                },
                "Action": [
                  "ecr:GetDownloadUrlForLayer",
                  "ecr:BatchGetImage",
                  "ecr:BatchCheckLayerAvailability"
                ],
                "Resource": "'"${REPO_ARN}"'"
              },
              {
                "Sid": "LambdaECRAuthorization",
                "Effect": "Allow",
                "Principal": {
                  "Service": "lambda.amazonaws.com"
                },
                "Action": "ecr:GetAuthorizationToken",
                "Resource": "*"
              }
            ]
          }'
          
          echo "Setting repository policy for Lambda image retrieval..."
          aws ecr set-repository-policy \
            --repository-name "$REPO_NAME" \
            --policy-text "$REPOSITORY_POLICY" \
            --region "${AWS_REGION}"
          
          echo "Repository policy set successfully"

      - name: Verify ECR Repository Configuration
        run: |
          set -euo pipefail
          
          REPO_NAME="${APP_NAME}"
          
          echo "=== ECR Repository Details ==="
          aws ecr describe-repositories \
            --repository-names "$REPO_NAME" \
            --region "${AWS_REGION}" \
            --query "repositories[0].{Name:repositoryName,URI:repositoryUri,RegistryId:registryId,Public:repositoryUri}" \
            --output table
          
          echo ""
          echo "=== Image Tag Mutability Settings ==="
          aws ecr describe-repositories \
            --repository-names "$REPO_NAME" \
            --region "${AWS_REGION}" \
            --query "repositories[0].{ImageTagMutability:imageTagMutability,ExclusionFilters:imageTagMutabilityExclusionFilters}" \
            --output json
          
          echo ""
          echo "=== Repository Policy ==="
          aws ecr get-repository-policy \
            --repository-name "$REPO_NAME" \
            --region "${AWS_REGION}" \
            --query "policyText" \
            --output text | jq '.' || echo "Policy retrieved successfully"
