name: Setup ECR Repository

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (development/qa/production)"
        required: true
        type: choice
        options:
          - development
          - production

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  APP_NAME: tow-management-system-api

jobs:
  create-ecr-repository:
    runs-on: ubuntu-latest

    # If manual run, use the chosen env; otherwise default to development (e.g., merges to main).
    environment: ${{ github.event_name == 'workflow_dispatch' && inputs.environment || 'development' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.GHA_RUNNER_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: account-id
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "AWS Account ID: $ACCOUNT_ID"

      - name: Create ECR Repository
        run: |
          set -euo pipefail
          
          REPO_NAME="${APP_NAME}"
          
          # Check if repository already exists
          if aws ecr describe-repositories \
            --repository-names "$REPO_NAME" \
            --region "${AWS_REGION}" >/dev/null 2>&1; then
            echo "ECR repository '$REPO_NAME' already exists"
            echo "Updating repository configuration..."
          
            # Update image tag mutability settings
            aws ecr put-image-tag-mutability \
              --repository-name "$REPO_NAME" \
              --image-tag-mutability MUTABLE_WITH_EXCLUSION \
              --image-tag-mutability-exclusion-filters filterType=WILDCARD,filter="v*" \
              --region "${AWS_REGION}"
          
            # Ensure repository is private (already created repositories are private by default)
            echo "Repository is private by default"
          else
            echo "Creating ECR repository: $REPO_NAME"
          
            # Create private repository with mutability settings
            aws ecr create-repository \
              --repository-name "$REPO_NAME" \
              --image-tag-mutability MUTABLE_WITH_EXCLUSION \
              --image-tag-mutability-exclusion-filters filterType=WILDCARD,filter="v*" \
              --region "${AWS_REGION}" >/dev/null
          
            echo "ECR repository '$REPO_NAME' created successfully"
          fi

      - name: Verify ECR Repository Configuration
        run: |
          set -euo pipefail
          
          REPO_NAME="${APP_NAME}"
          
          echo "=== ECR Repository Details ==="
          aws ecr describe-repositories \
            --repository-names "$REPO_NAME" \
            --region "${AWS_REGION}" \
            --query "repositories[0].{Name:repositoryName,URI:repositoryUri,RegistryId:registryId,Public:repositoryUri}" \
            --output table
          
          echo ""
          echo "=== Image Tag Mutability Settings ==="
          aws ecr describe-repositories \
            --repository-names "$REPO_NAME" \
            --region "${AWS_REGION}" \
            --query "repositories[0].{ImageTagMutability:imageTagMutability,ExclusionFilters:imageTagMutabilityExclusionFilters}" \
            --output json
