name: Setup-Permissions

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (development/production)"
        required: true
        type: choice
        options:
          - development
          - production

env:
  AWS_REGION: us-east-1

jobs:
  create-iam-policies:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'development' }}
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Display selected environment
        run: |
          ENV="${{ github.event.inputs.environment || 'development' }}"
          echo "Running workflow for environment: $ENV"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.GHA_RUNNER_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create lambda-location-full-access-policy
        run: |
          POLICY_NAME="lambda-location-full-access-policy"
          POLICY_DOCUMENT='{
            "Version": "2012-10-17",
            "Statement": [
              {
                "Sid": "VisualEditor0",
                "Effect": "Allow",
                "Action": [
                  "geo:ListDevicePositions",
                  "geo:GetDevicePosition",
                  "geo:CalculateRoute",
                  "geo-routes:*",
                  "geo:DescribePlaceIndex",
                  "geo:DescribeGeofenceCollection",
                  "geo:SearchPlaceIndexForPosition",
                  "geo:GetPlace",
                  "geo:ListTrackerConsumers",
                  "geo-places:*",
                  "geo:*",
                  "geo:GetMapTile",
                  "geo:ForecastGeofenceEvents",
                  "geo:SearchPlaceIndexForText",
                  "geo:DescribeKey",
                  "geo:VerifyDevicePosition",
                  "geo:DescribeMap",
                  "geo:BatchGetDevicePosition",
                  "geo:GetMapGlyphs",
                  "geo:ListTagsForResource",
                  "geo:GetDevicePositionHistory",
                  "geo:DescribeTracker",
                  "geo:GetMapSprites",
                  "geo:GetMapStyleDescriptor",
                  "geo:CalculateRouteMatrix",
                  "geo:ListGeofences",
                  "geo:GetGeofence",
                  "geo-maps:*",
                  "geo:SearchPlaceIndexForSuggestions",
                  "geo:DescribeRouteCalculator"
                ],
                "Resource": "*"
              }
            ]
          }'
          
          # Check if policy already exists
          POLICY_ARN=$(aws iam list-policies --query "Policies[?PolicyName=='$POLICY_NAME'].Arn" --output text 2>/dev/null || echo "")
          
          if [ -z "$POLICY_ARN" ]; then
            echo "Creating policy: $POLICY_NAME"
            aws iam create-policy \
              --policy-name "$POLICY_NAME" \
              --policy-document "$POLICY_DOCUMENT" \
              --description "Policy for Lambda function to access AWS Location services"
          else
            echo "Policy $POLICY_NAME already exists with ARN: $POLICY_ARN"
            echo "Updating policy version..."
            aws iam create-policy-version \
              --policy-arn "$POLICY_ARN" \
              --policy-document "$POLICY_DOCUMENT" \
              --set-as-default
          fi

      - name: Create lambda-ses-sendrawemail-policy
        run: |
          POLICY_NAME="lambda-ses-sendrawemail-policy"
          POLICY_DOCUMENT='{
            "Version": "2012-10-17",
            "Statement": [
              {
                "Sid": "SID1",
                "Effect": "Allow",
                "Action": "ses:SendEmail",
                "Resource": "*"
              },
              {
                "Sid": "SID2",
                "Effect": "Allow",
                "Action": "ses:SendRawEmail",
                "Resource": "*"
              }
            ]
          }'
          
          # Check if policy already exists
          POLICY_ARN=$(aws iam list-policies --query "Policies[?PolicyName=='$POLICY_NAME'].Arn" --output text 2>/dev/null || echo "")
          
          if [ -z "$POLICY_ARN" ]; then
            echo "Creating policy: $POLICY_NAME"
            aws iam create-policy \
              --policy-name "$POLICY_NAME" \
              --policy-document "$POLICY_DOCUMENT" \
              --description "Policy for Lambda function to send emails via SES"
          else
            echo "Policy $POLICY_NAME already exists with ARN: $POLICY_ARN"
            echo "Updating policy version..."
            aws iam create-policy-version \
              --policy-arn "$POLICY_ARN" \
              --policy-document "$POLICY_DOCUMENT" \
              --set-as-default
          fi

      - name: Create tow-management-system-api role
        run: |
          ROLE_NAME="tow-management-system-api"
          
          # Get AWS account ID
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          
          # Get ARNs of customer-managed policies
          LOCATION_POLICY_ARN=$(aws iam list-policies --query "Policies[?PolicyName=='lambda-location-full-access-policy'].Arn" --output text)
          SES_POLICY_ARN=$(aws iam list-policies --query "Policies[?PolicyName=='lambda-ses-sendrawemail-policy'].Arn" --output text)
          
          # Managed policy ARN
          LAMBDA_BASIC_EXECUTION_ROLE_ARN="arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
          
          # Trust policy for Lambda service
          TRUST_POLICY='{
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Service": "lambda.amazonaws.com"
                },
                "Action": "sts:AssumeRole"
              }
            ]
          }'
          
          # Check if role already exists
          if aws iam get-role --role-name "$ROLE_NAME" &>/dev/null; then
            echo "Role $ROLE_NAME already exists"
            echo "Updating trust policy..."
            aws iam update-assume-role-policy \
              --role-name "$ROLE_NAME" \
              --policy-document "$TRUST_POLICY"
          else
            echo "Creating role: $ROLE_NAME"
            aws iam create-role \
              --role-name "$ROLE_NAME" \
              --assume-role-policy-document "$TRUST_POLICY" \
              --description "IAM role for tow-management-system-api Lambda function"
          fi
          
          # Attach managed policy
          echo "Attaching AWSLambdaBasicExecutionRole..."
          aws iam attach-role-policy \
            --role-name "$ROLE_NAME" \
            --policy-arn "$LAMBDA_BASIC_EXECUTION_ROLE_ARN" || echo "Policy already attached or failed to attach"
          
          # Attach customer-managed policies
          echo "Attaching lambda-location-full-access-policy..."
          aws iam attach-role-policy \
            --role-name "$ROLE_NAME" \
            --policy-arn "$LOCATION_POLICY_ARN" || echo "Policy already attached or failed to attach"
          
          echo "Attaching lambda-ses-sendrawemail-policy..."
          aws iam attach-role-policy \
            --role-name "$ROLE_NAME" \
            --policy-arn "$SES_POLICY_ARN" || echo "Policy already attached or failed to attach"
          
          echo "Role $ROLE_NAME created/updated successfully"

      - name: List created policies
        run: |
          echo "Created/Updated policies:"
          aws iam list-policies --query "Policies[?PolicyName=='lambda-location-full-access-policy' || PolicyName=='lambda-ses-sendrawemail-policy'].{Name:PolicyName,Arn:Arn}" --output table

